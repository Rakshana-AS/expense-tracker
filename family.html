<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Family Expense Tracker</title>

  <!-- Chart.js + DataLabels plugin -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>

  <style>
    * { box-sizing: border-box; font-family: 'Poppins', sans-serif; margin:0; padding:0; }
    body { display:flex; min-height:100vh; background:#f5f7fb; color:#333; }

    /* Sidebar */
    .sidebar {
      width:230px; background:#4facfe; color:#fff; padding:1rem;
      border-top-right-radius:20px; border-bottom-right-radius:20px; display:flex; flex-direction:column;
    }
    .sidebar h2{ text-align:center; margin-bottom:1rem; }
    .menu-item{ padding:0.8rem 1rem; margin:0.3rem 0; border-radius:8px; cursor:pointer; }
    .menu-item a{ color:inherit; text-decoration:none; display:block; }
    .menu-item.active, .menu-item:hover{ background:#00c3ff; }

    /* Main content */
    .main-content {
      flex:1; padding:1.4rem; overflow-y:auto; display:flex; flex-direction:column; gap:1rem;
    }
    h1{ color:#4facfe; margin-bottom:0.2rem; text-align:center; }

    .summary {
      background:#fff; padding:1rem 1.25rem; border-radius:12px; box-shadow:0 4px 10px rgba(0,0,0,0.08);
      display:flex; gap:1rem; justify-content:space-around; flex-wrap:wrap; align-items:center; max-width:1100px; margin:0 auto;
    }
    .summary h3{ color:#4facfe; margin-bottom:0.35rem; }
    .budget-input { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }

    .add-expense { display:flex; gap:10px; align-items:center; justify-content:center; flex-wrap:wrap; }

    select, input, button { padding:0.6rem; border-radius:8px; border:1px solid #ccc; font-size:1rem; }
    button { background:#4facfe; color:#fff; border:none; cursor:pointer; }
    button.reset { background:#ff5f5f; }

    .chart-section { background:#fff; padding:1rem; border-radius:12px; box-shadow:0 4px 10px rgba(0,0,0,0.06); text-align:center; max-width:900px; margin:0 auto; }

    .family-members { background:#fff; padding:1rem; border-radius:12px; box-shadow:0 6px 14px rgba(0,0,0,0.06); width:90%; max-width:1100px; margin:0 auto 2rem; }

    .member { border-bottom:1px solid #eee; padding:1rem 0; }
    .member:last-child{ border-bottom:none; }
    .member-header { display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap; }
    .member-name { font-size:1.1rem; font-weight:700; color:#4facfe; }

    .member-content { display:flex; gap:1.25rem; flex-wrap:wrap; align-items:flex-start; margin-top:0.75rem; }
    .member-chart { flex:0 0 320px; max-width:320px; background:#fafcff; padding:8px; border-radius:8px; text-align:center; }
    .member-table { flex:1; min-width:280px; background:#fff; padding:8px; border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,0.04); }

    table { width:100%; border-collapse:collapse; font-size:0.95rem; }
    th, td { padding:0.45rem; text-align:center; border-bottom:1px solid #eee; }
    th { background:#f0f8ff; color:#333; }
    .highlight { background:#fff3cd; font-weight:700; }
    .totals { font-weight:700; background:#eaf6ff; }

    .member-expense-input { display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-top:0.6rem; }

    .small-btn { padding:0.45rem 0.6rem; font-size:0.9rem; border-radius:6px; }

    .tip { margin-top:6px; color:#c0392b; font-weight:600; }

    @media (max-width:900px){
      .sidebar{ width:100%; display:flex; flex-direction:row; justify-content:space-around; border-radius:0; }
      body{ flex-direction:column; }
      .member-content{ flex-direction:column; align-items:center; }
      .member-chart{ width:90%; max-width:420px; }
      .member-table{ width:95%; }
    }
  </style>
</head>
<body>
  <!-- Sidebar -->
  <div class="sidebar">
    <h2>Menu</h2>
    <div class="menu-item"> <a href="home.html" style="text-decoration: none;">üìä Expense Charts</a></div>
    <div class="menu-item"><a href="family.html" style="text-decoration: none;">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Family</a></div>
    <div class="menu-item"><a href="financial plan.html" style="text-decoration: none;">üí∞ Financial Plan</a></div>
    <div class="menu-item"><a href="settings.html" style="text-decoration: none;">‚öôÔ∏è Settings</a></div>
  </div>

  <!-- Main Dashboard -->
  <div class="main-content">
    <h1>Family Expense Tracker</h1>

    <!-- Family Summary -->
    <div class="summary">
      <div class="budget-input">
        <div>
          <h3>Total Family Budget</h3>
          <div style="display:flex; gap:8px; align-items:center;">
            <input type="number" id="family-budget-input" placeholder="Enter ‚Çπ" min="0" />
            <button id="set-family-budget" class="small-btn">Set</button>
            <button id="clear-family-budget" class="small-btn reset">Clear</button>
          </div>
        </div>
      </div>

      <div>
        <h3>Total Spent</h3>
        <p id="family-spent">‚Çπ0</p>
      </div>

      <div>
        <h3>Remaining</h3>
        <p id="family-remaining">‚Çπ0</p>
      </div>
    </div>

    <!-- Add Family Expense -->
    <div class="add-expense" style="justify-content:center;">
      <select id="family-category">
        <option value="Groceries">Groceries</option>
        <option value="Parlour">Parlour</option>
        <option value="Gym">Gym</option>
        <option value="Sports">Sports</option>
        <option value="Shopping">Shopping</option>
        <option value="Health">Health</option>
        <option value="Travel">Travel</option>
        <option value="Entertainment">Entertainment</option>
        <option value="Vehicle">Vehicle</option>
        <option value="Misc">Misc</option>
      </select>

      <input type="number" id="family-amount" placeholder="Amount (‚Çπ)" min="1" />
      <button id="add-family-expense">Add Expense</button>
      <button id="reset-family" class="reset">Reset</button>
    </div>

    <div class="chart-section">
      <h3>Family Expense Distribution</h3>
      <canvas id="familyChart" style="max-width:820px; margin:0 auto;"></canvas>
    </div>

    <!-- Family Members Section -->
    <div class="family-members">
      <h2 style="color:#4facfe; text-align:center; margin-bottom:1rem;">Family Members</h2>
      <div id="members-container"></div>

      <div style="text-align:center; margin-top:1rem;">
        <button id="add-member">‚ûï Add Member</button>
      </div>
    </div>
  </div>

  <script>
    const familyCategories = ['Groceries','Parlour','Gym','Sports','Shopping','Health','Travel','Entertainment','Vehicle','Misc'];

    // Load state
    let familyExpenses = JSON.parse(localStorage.getItem('familyExpenses')) || Object.fromEntries(familyCategories.map(c => [c, 0]));
    let familyBudget = parseFloat(localStorage.getItem('familyBudget')) || 0;
    let members = JSON.parse(localStorage.getItem('familyMembers')) || [
      { name: 'Member 1', expenses: Object.fromEntries(familyCategories.map(c=>[c,0])) },
      { name: 'Member 2', expenses: Object.fromEntries(familyCategories.map(c=>[c,0])) }
    ];

    // color palette (10 colors)
    const colors = ['#845ec2','#ff9671','#ffc75f','#f9f871','#00c9a7','#4facfe','#fa709a','#0081cf','#b39cd0','#9ad3bc'];

    // family chart
    const ctx = document.getElementById('familyChart').getContext('2d');
    const familyChart = new Chart(ctx, {
      type: 'pie',
      data: {
        labels: familyCategories,
        datasets: [{
          data: Object.values(familyExpenses),
          backgroundColor: colors
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { position: 'bottom' },
          datalabels: {
            formatter: (value, ctx) => {
              const data = ctx.chart.data.datasets[0].data;
              const total = data.reduce((a,b)=>a+b,0);
              return total ? ( (value/total)*100 ).toFixed(1) + '%' : '';
            },
            color:'#fff',
            font:{ weight:'600', size:11 }
          },
          title: { display:true, text:'Family Expense (%)' }
        }
      },
      plugins: [ChartDataLabels]
    });

    // DOM refs
    const familySpentEl = document.getElementById('family-spent');
    const familyRemainingEl = document.getElementById('family-remaining');
    const budgetInput = document.getElementById('family-budget-input');

    function saveState(){
      localStorage.setItem('familyExpenses', JSON.stringify(familyExpenses));
      localStorage.setItem('familyBudget', familyBudget);
      localStorage.setItem('familyMembers', JSON.stringify(members));
    }

    function updateFamilySummary(){
      const total = Object.values(familyExpenses).reduce((a,b)=>a+b,0);
      familySpentEl.textContent = `‚Çπ${total}`;
      familyRemainingEl.textContent = `‚Çπ${Math.max(familyBudget - total, 0)}`;
      // warning note display logic (optional): if over budget or near budget
      saveState();
    }

    function updateFamilyChart(){
      familyChart.data.datasets[0].data = Object.values(familyExpenses);
      familyChart.update();
      updateFamilySummary();
    }

    // set/clear budget
    document.getElementById('set-family-budget').addEventListener('click', ()=>{
      const val = parseFloat(budgetInput.value);
      if(!val || val < 0){ alert('Enter valid budget'); return; }
      familyBudget = val;
      budgetInput.value = '';
      updateFamilyChart();
    });
    document.getElementById('clear-family-budget').addEventListener('click', ()=>{
      if(!confirm('Clear family budget?')) return;
      familyBudget = 0;
      localStorage.removeItem('familyBudget');
      updateFamilyChart();
    });

    // add/reset family expense
    document.getElementById('add-family-expense').addEventListener('click', ()=>{
      const cat = document.getElementById('family-category').value;
      const amt = parseFloat(document.getElementById('family-amount').value);
      if(!amt || amt <= 0) return alert('Enter valid amount');
      if(!familyBudget) return alert('Set family budget first');
      familyExpenses[cat] = (familyExpenses[cat] || 0) + amt;
      document.getElementById('family-amount').value = '';
      updateFamilyChart();
    });

    document.getElementById('reset-family').addEventListener('click', ()=>{
      if(!confirm('Reset all family expenses?')) return;
      familyExpenses = Object.fromEntries(familyCategories.map(c=>[c,0]));
      updateFamilyChart();
    });

    // Members UI
    const membersContainer = document.getElementById('members-container');

    function drawMemberChart(i){
      const canvas = document.getElementById(`chart-${i}`);
      if(!canvas) return;
      const ctx = canvas.getContext('2d');
      // destroy existing chart object if it's present to avoid duplicates
      if(canvas._chart) { canvas._chart.destroy(); canvas._chart = null; }
      const dataArr = familyCategories.map(c => members[i].expenses[c] || 0);
      const chart = new Chart(ctx, {
        type: 'pie',
        data: { labels: familyCategories, datasets: [{ data: dataArr, backgroundColor: colors }] },
        options: {
          responsive:true,
          plugins:{
            legend:{ display:false },
            datalabels:{
              formatter:(value, ctx)=>{
                const data = ctx.chart.data.datasets[0].data;
                const total = data.reduce((a,b)=>a+b,0);
                return total ? ((value/total)*100).toFixed(1) + '%' : '';
              },
              color:'#fff', font:{ weight:'600', size:10 }
            },
            title:{ display:true, text: members[i].name }
          }
        },
        plugins: [ChartDataLabels]
      });
      canvas._chart = chart;
    }

    function renderMembers(){
      membersContainer.innerHTML = '';
      members.forEach((m, i) => {
        // compute totals, max category and remaining (simple split of familyBudget)
        const totalSpent = Object.values(m.expenses).reduce((a,b)=>a+b,0);
        const perMemberBudget = familyBudget ? (familyBudget / Math.max(members.length,1)) : 0;
        const remaining = Math.max(perMemberBudget - totalSpent, 0);

        // find max category (if all zero, maxCat = null)
        let maxCat = null;
        let maxVal = 0;
        for(const c of familyCategories){
          const v = m.expenses[c] || 0;
          if(v > maxVal){ maxVal = v; maxCat = c; }
        }

        const memberDiv = document.createElement('div');
        memberDiv.className = 'member';
        memberDiv.innerHTML = `
          <div class="member-header">
            <div class="member-name">${m.name}</div>
            <div style="display:flex; gap:8px; align-items:center;">
              <button class="rename-btn small-btn" data-index="${i}">Rename</button>
              <button class="delete-btn small-btn" data-index="${i}">Delete</button>
            </div>
          </div>

          <div class="member-expense-input">
            <select id="member-cat-${i}">
              ${familyCategories.map(c => `<option value="${c}">${c}</option>`).join('')}
            </select>
            <input type="number" id="member-amt-${i}" placeholder="Amount (‚Çπ)" min="1" />
            <button class="add-member-expense small-btn" data-index="${i}">Add</button>
            <button class="reset-member reset small-btn" data-index="${i}">Reset</button>
          </div>

          <div class="member-content">
            <div class="member-chart">
              <canvas id="chart-${i}" width="320" height="220"></canvas>
            </div>

            <div class="member-table">
              <table>
                <thead>
                  <tr><th>Category</th><th>Amount (‚Çπ)</th><th>% of Member</th></tr>
                </thead>
                <tbody>
                  ${familyCategories.map(c=>{
                    const amt = m.expenses[c] || 0;
                    const pct = totalSpent ? ((amt/totalSpent)*100).toFixed(1) : '0.0';
                    const cls = (c === maxCat && maxVal>0) ? 'highlight' : '';
                    return `<tr class="${cls}"><td>${c}</td><td>‚Çπ${amt}</td><td>${pct}%</td></tr>`;
                  }).join('')}
                </tbody>
                <tfoot>
                  <tr class="totals"><td>Total</td><td>‚Çπ${totalSpent}</td><td>100%</td></tr>
                  <tr class="totals"><td>Remaining</td><td colspan="2">‚Çπ${remaining.toFixed(2)}</td></tr>
                </tfoot>
              </table>
              <div class="tip">${maxCat ? `üí° Tip: Highest spend on ${maxCat}. Try to reduce next month.` : ''}</div>
            </div>
          </div>
        `;
        membersContainer.appendChild(memberDiv);

        // draw member chart
        drawMemberChart(i);
      });

      // persist members
      saveState();
    }

    // member actions (rename, delete, add expense, reset member)
    membersContainer.addEventListener('click', (e) => {
      const idx = e.target.dataset.index;
      if(e.target.classList.contains('rename-btn')){
        const name = prompt('New name:', members[idx].name);
        if(name){ members[idx].name = name; renderMembers(); updateFamilyChart(); }
      }

      if(e.target.classList.contains('delete-btn')){
        if(!confirm(`Delete ${members[idx].name}? This will subtract their expenses from family totals.`)) return;
        // deduct member expenses from family totals
        for(const c of familyCategories){
          familyExpenses[c] = (familyExpenses[c] || 0) - (members[idx].expenses[c] || 0);
          if(familyExpenses[c] < 0) familyExpenses[c] = 0;
        }
        members.splice(idx,1);
        renderMembers();
        updateFamilyChart();
      }

      if(e.target.classList.contains('add-member-expense')){
        const i = parseInt(idx);
        const cat = document.getElementById(`member-cat-${i}`).value;
        const amt = parseFloat(document.getElementById(`member-amt-${i}`).value);
        if(!amt || amt <= 0) return alert('Enter valid amount');
        if(!familyBudget) return alert('Set family budget first');
        // update member and family totals
        members[i].expenses[cat] = (members[i].expenses[cat] || 0) + amt;
        familyExpenses[cat] = (familyExpenses[cat] || 0) + amt;
        document.getElementById(`member-amt-${i}`).value = '';
        renderMembers();
        updateFamilyChart();
      }

      if(e.target.classList.contains('reset-member')){
        const i = parseInt(idx);
        if(!confirm(`Reset all expenses for ${members[i].name}?`)) return;
        for(const c of familyCategories){
          familyExpenses[c] = (familyExpenses[c] || 0) - (members[i].expenses[c] || 0);
          if(familyExpenses[c] < 0) familyExpenses[c] = 0;
        }
        members[i].expenses = Object.fromEntries(familyCategories.map(c=>[c,0]));
        renderMembers();
        updateFamilyChart();
      }
    });

    // add-member button
    document.getElementById('add-member').addEventListener('click', ()=>{
      const name = prompt('Enter new member name:');
      if(!name) return;
      members.push({ name, expenses: Object.fromEntries(familyCategories.map(c=>[c,0])) });
      renderMembers();
    });

    // initial render
    renderMembers();
    updateFamilyChart();
  </script>
</body>
</html>
